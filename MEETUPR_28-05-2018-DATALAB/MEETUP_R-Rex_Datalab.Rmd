---
title: "REX sur la mise en place d'un datalab R à RTE"
subtitle: "Meetup R Addicts x EDF"
author: "Christophe Dervieux"
date: "28 mai 2018"
output:
  xaringan::moon_reader:
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    css: [default, custom.css]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      # beforeInit: "macros.js"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

# A propos

* Utilisateurs de R depuis 6 ans maintenant
* RTE (Réseau de Transport d'Electricité)
* Depuis + d'1 an, en appui autour des sujets/projets R pour les chargés d'études et développeurs
  * Expertise
  * Formation
  * Déploiement - Mise en production
  * Solutions mutualisées pour les utilisateurs

.box[Mise en place d'un datalab]

???

Rattaché au niveau du SI dans les démarches d'open data interne.

Sujets:
- Développement de packages
- Mise en place datalab
- Conseil développement et expertise

---

# R en entreprise
.subtitle[C'est pas comme à la maison]

.pull-left[
**Poste de travail pas toujours adapté**
+ Pas son poste perso
+ Offre bureautique, non scientifique
+ Sécurité : Je ne peux pas vraiment faire ce que je veux (Proxy, non admin, ...)
]

.pull-right[
**Cadre technique de l'entreprise contraignant**
+ Respect d'un cadre technique pour le déploiement d'application en production
+ R non connu et référencé dans _les technologies validées_
+ Pas de solution de type cloud à disposition
]

.center[ 
**Comment améliorer le cadre de travail ?**  
**Contribuer à la transformation numérique de l'entreprise**
]

???

Pas de github, pas de travis, pas de codecov, etc... 

Pas open source donc pas gratuit

Je n'installe pas ce que je veux malheureusement 

Cadre limité

---

# Les grandes idées

### Mutualisé
+ Collaboration entre équipes sur des projets
+ Accés aux données l'entreprise
+ Partage de la ressource de calcul

--

### prêt à l'emploi
+ Juste à se connecter
+ Pas d'installation, pas de configuration
+ Permettre à des débutants d'utiliser R comme un outil de manipulation de donnée

--

### accompagné de service et solutions
+ Intégration à d'autres solutions
+ Packages Internes
+ Support / Expertise 

???

+ Offrir un environnemnt d'étude et de développement **mutualisé** et **prêt à l'emploi** 
+ Proposer des **services en interne** pour les datascientists, chargés d'études et développeurs.

Pleins de possibilités sur le web (shinyapps.io, Rpubs, Github, Github pages, Travis, ...). Et en interne ?

POurquoi ? Pour qui ?

Avantage: 
+ Déporté

Excel ++

**Mutualisé**: 
+ Favoriser la collaboration entre équipes sur des projets
+ Pouvoir accéder à des données centralisées (DataLake, DataWareHouse, ...)
+ Partager la ressource de calcul

**Prêt à l'emploi**:
+ Juste à se connecter, pas d'installation à faire, de version à gérer
+ Permettre à des débutants d'utiliser R comme un outil de manipulation de donnée

**Service en interne**:
+ Pleins de possibilités sur le web (shinyapps.io, Rpubs, Github, Github pages, Travis, ...). Et en interne ?

---

# Mis en place 

.subtitle[Solution interne en mode serveurs]

.center[

```{r, results='asis', echo = FALSE}
cat(readLines("draw-io_embded.txt"))
```

**En constante évolution**  
**Objectif: mettre R au coeur des usages pour la donnée**

]

???

+ 2 serveurs Rstudio Pro en cluster
+ 1 sereurs RStudio Connect
+ Un miroir interne du CRAN, avec possibilité de publier des packages internes
+ Accès à "l'usine de développement" (Gitlab, Jenkins, Nexus, SonarQube)
+ Accès aux données de l'entreprise

Lien vers présentation Benoit lors de sa conf

---

# Admin R ?
.subtitle[S'adapter à un contexte technique d'entreprise]

.center[
```{r echo=FALSE, fig.height=5, fig.width=5}
set.seed(9456)
words <- c("NAS", "LDAP", "ACLv3", "KERBEROS", "ACLv4", "NTLM", "HTTP_PROXY", "Redhat", "PAM", "CLI",
           "ODBC", "DSN", "FreeIPA", "ODBA", "EXADATA", "SSL", "kinit", "Datacenter", "API", 
           "odbc.ini", "Rprofile.site", "Proxy", "Parquet", "Hive", "Impala", "Oracle")
# words <- sample(words, size = 30, replace = length(words) < 30)
freq <- sample(1:50, size = length(words), replace = TRUE)
wordcloud::wordcloud(words, freq, 
                     colors = RColorBrewer::brewer.pal(6,"Dark2"), 
                     random.color = TRUE, rot.per = 0.2,
                     scale =c(4, 1.5))
```
]
---
layout: true
# Retour d'expérience 
---
count:false
---

.left-column[
### Gestion des librairies
]

.right-column[

Mirroir CRAN interne car environnement offline

Défi des dépendances systèmes  
(`sysreq` by RHub à la rescousse)

Librairies partagées sur les serveurs (`R_LIBS_SITE`)

Dépot de package interne

Solution spécifique à R ou même solutions que les autres languages ?
]

---

.left-column[
### Gestion des librairies
### Facilité par RStudio
]

.right-column[
Multiple version de R

Multi-session

Authentification

Monitoring des environnements

Configuration de serveur

Connectivité aux sources de données
]



---

.left-column[
### Gestion des librairies
### Facilité par RStudio
### Customisation
]

.right-column[
### Simplifier l'utilisation

+ Au niveau de R : _Rprofile.site_ et _Renviron.site_  

+ Au niveau des configurations RStudio

###  Améliorer l'expérience
+ Connexion centralisé aux données 

+ [Connection contract]()

+ [Addins RStudio]()

+ [Projet template]()
]
---
layout: true
# Et à propos de R en prod ?

.subtitle[Favoriser le déploiement]

---
count: false
---

.left-column[
### Principalement des apps shiny
]

.right-column[
+ Environnement de publication du datalab
  + Facile grâce à RStudio Connect 
  + app Shiny, dashboard, rapport et présentation 

+ Environnement dédié en datacenter
  + Cas particulier
  + Revu de l'architecture logiciel

+ A venir: Docker
  + Standard DevOps de l'entreprise
  + Nécesite adaptation du contexte technique
]

---

.left-column[
### Principalement des apps shiny
### {packrat} à la rescousse
]

.right-column[
`packrat.lock` généré dans le datalab

```{r, eval = FALSE}
# Générer uniquement le fichier packrat.lock
library(packrat)
.snapshotImpl(project = ".", 
              snapshot.sources = FALSE)
```

puis `packrat::restore()` dans l'environnement de déploiement le déploiement. 
Astuce: un cache packrat pour accélérer le déploiement.

```{r, eval = FALSE}
library(packrat)
Sys.setenv(
  R_PACKRAT_CACHE_DIR = "<global-cache-dir>"
  )
set_opts(use.cache = TRUE)
restore()
```

] 

---

.left-column[
### Principalement des apps shiny
### {packrat} à la rescousse
### {config} pour adapter les configurations
]

.right-column[
Un fichier à adapter uniquement : `config.yml`:
```yaml
default:
  db-name: "db-test.acme.com"
  log-folder: "./local-log-folder"
  
production:
  db-name: "db-prod.acme.com"
  log-folder: "/mnt/shared-log-folder"
```
Le code R n'a pas à être changé:
```{r, eval = FALSE}
db_name <- config::get("db-name")
log-path <- config::get("log-folder")
```

Dans l'environnement de déploiement
```{r, eval = FALSE}
Sys.setenv(R_CONFIG_ACTIVE = "production")
```


]

---
layout: false
# De l'appui dans la communauté

--

##  _R Admin_ sur community.rstudio.com

https://community.rstudio.com/c/r-admin

> This category is for discussions about R in production, at scale, and in complex environments.

## _R for Entreprise_ sur le blog RViews

https://rviews.rstudio.com/categories/r-for-the-enterprise/)

---
class: inverse, center, middle, title-slide
count: false
## MERCI
