---
title: "'Datalab' pour R</br>Partage d'experience"
subtitle: "Meetup R Addicts"
author: "Christophe Dervieux"
date: "28 mai 2018"
output:
  xaringan::moon_reader:
    lib_dir: libs
    chakra: libs/remark-latest.min.js
    css: [default, custom.css]
    nature:
      highlightStyle: zenburn
      highlightSpans: true
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

# A propos

### Utilisateurs de `r icon::fa_r_project()` depuis 6 ans
</br>    
### <img src="https://www.rte-france.com/sites/all/themes/rte/images/logo.png" height= "30" width="30"> RTE (Réseau de Transport d'Electricité)<sup>1</sup> 
</br>
### Depuis + d'un an, entre autre, en appui autour des sujets/projets `r icon::fa_r_project()` 
</br>    
.pull-left[
.center[
### `r icon::fa_github()`
@cderv
]
]

.pull-right[
.center[
### `r icon::fa_twitter()`
@chrisderv
]
]

.footnote[
[1] mais cette présentation n'est pas dans un cadre officiel - juste un partage personnel. 
]

???

Rattaché au niveau du SI dans les démarches d'open data interne.

Sujets:
- Développement de packages
- Mise en place datalab
- Conseil développement et expertise

---

# `r icon::fa_r_project()` en entreprise
.subtitle[C'est pas comme à la maison]

.pull-left[
### Poste de travail </br> pas toujours adapté
+ Pas son poste perso

+ Offre bureautique, non scientifique

+ Sécurité = Limitation</br>(Proxy, non admin, ...)
]

.pull-right[
### Cadre technique de l'entreprise contraignant
+ Règle pour le déploiement d'application en production

+ `r icon::fa_github()` non référencé dans _les technologies validées_

+ Pas (encore ?) de cloud à disposition
]

.box[
.center[ 
**Comment améliorer le cadre de travail ?**  
**Contribuer à la transformation numérique de l'entreprise ?** 
]
]

???

Pas de github, pas de travis, pas de codecov, etc... 

Pas open source donc pas gratuit

Je n'installe pas ce que je veux malheureusement 

Cadre limité

---

# Les grandes idées

.subtitle[pour un 'datalab']

### Mutualisé
+ Collaboration entre équipes sur des projets
+ Accés aux données l'entreprise
+ Partage de la ressource de calcul

--

### Prêt à l'emploi
+ Juste à se connecter
+ Pas d'installation, pas de configuration
+ Permettre à des débutants d'utiliser `r icon::fa_r_project()` comme un outil de manipulation de donnée avancée

--

### Accompagné de services et solutions
+ Intégrer à d'autres solutions
+ Favoriser les packages internes adapté au cadre de l'entreprise
+ Offrir support & expertise 

???

+ Offrir un environnemnt d'étude et de développement **mutualisé** et **prêt à l'emploi** 
+ Proposer des **services en interne** pour les datascientists, chargés d'études et développeurs.

Pleins de possibilités sur le web (shinyapps.io, Rpubs, Github, Github pages, Travis, ...). Et en interne ?

POurquoi ? Pour qui ?

Avantage: 
+ Déporté

Excel ++

---

# Mis en place 

.subtitle[Solution interne en mode serveurs]

.center[

```{r, results='asis', echo = FALSE}
cat(readLines("draw-io_embded.txt"))
```

### En constante évolution
]

???

+ 2 serveurs Rstudio Pro en cluster
+ 1 serveur RStudio Connect
+ Un miroir interne du CRAN, avec possibilité de publier des packages internes
+ Accès à "l'usine de développement" (Gitlab, Jenkins, Nexus, SonarQube)
+ Accès aux données de l'entreprise

---

# Admin R ?
.subtitle[S'adapter à un contexte technique d'entreprise]

.center[
```{r echo=FALSE, fig.height=5, fig.width=5}
set.seed(9456)
words <- c("NAS", "LDAP", "ACLv3", "KERBEROS", "ACLv4", "NTLM", "HTTP_PROXY", "Redhat", "PAM", "CLI",
           "ODBC", "DSN", "FreeIPA", "ODBA", "EXADATA", "SSL", "kinit", "Datacenter", "API", 
           "odbc.ini", "Rprofile.site", "Proxy", "Parquet", "Hive", "Impala", "Oracle")
# words <- sample(words, size = 30, replace = length(words) < 30)
freq <- sample(1:50, size = length(words), replace = TRUE)
wordcloud::wordcloud(words, freq, 
                     colors = RColorBrewer::brewer.pal(6,"Dark2"), 
                     random.color = TRUE, rot.per = 0.2,
                     scale =c(4, 1.5))
```
]
---
layout: true
# Retour d'expérience 
.subtitle[et réflexions...]
---
count:false
---

.left-column[
### Gestion des librairies
]

.right-column[

* Mirroir CRAN interne car environnement offline

* Défi des dépendances systèmes </br>(Service [`sysreqs`](https://sysreqs.r-hub.io/) by RHub à la rescousse)

* Librairies partagées sur les serveurs (`R_LIBS_SITE`)

* Dépot de package interne
.center[
.color1[**Solution spécifique à `r icon::fa_r_project()` ou même solution<br>que les autres languages ?**]
]
]
---

.left-column[
### Gestion des librairies
### Facilité par RStudio pro
]

.right-column[
* .color1[Multiple versions] de R

* .color1[Multi-sessions] pour les utilisateurs

* .color1[Authentification] d'entreprise

* .color1[Monitoring] des environnements

* .color1[Configuration de sessions R] pour le serveur

* Connectivité aux .color1[sources de données] facilitée

* .color1[Load Balancing]

* .color1[**Support**]
]

---

.left-column[
### Gestion des librairies
### Facilité par RStudio
### Customisation
]

.right-column[
### Simplifier l'utilisation

+ Au niveau de `r icon::fa_r_project()` : _Rprofile.site_ et _Renviron.site_  
+ Au niveau des configurations RStudio

###  Améliorer l'expérience

+ Centralisation des accès aux données</br>(DSN, Kerberos, ...) 
+ Adapter l'onglet _connections_</br>
([Connection contract](https://db.rstudio.com/advanced/contract))
+ Ajouter des fonctionnalités dans le contexte RTE </br>
( [Addins RStudio](https://rstudio.github.io/rstudio-extensions/rstudio_addins.html), [RStudio API](https://rstudio.github.io/rstudio-extensions/rstudioapi.html), [Snippet](https://rstudio.github.io/rstudio-extensions/rstudio_snippets.html))
+ .color1[**Template** interne]</br>([Projet template](https://rstudio.github.io/rstudio-extensions/rstudio_project_templates.html), [Rmarkdown templates](https://rstudio.github.io/rstudio-extensions/rmarkdown_templates.html))

.center[_https://rstudio.github.io/rstudio-extensions_]

]

---
layout: true
# Et à propos de `r icon::fa_r_project()` en prod ?

.subtitle[Favoriser le déploiement]

---
count: false
---

.left-column[
### Principalement des apps shiny
]

.right-column[
+ Environnement de publication du datalab
  + Facile grâce à .color1[RStudio Connect]
  + app Shiny, dashboard, rapport et présentation 

+ Environnement dédié en datacenter
  + Cas particuliers
  + Demande de revoir la conception

+ Docker ?
  + Standard DevOps de l'entreprise
  + Nécesite une adaptation du contexte technique
]

---

.left-column[
### Principalement des apps shiny
### {packrat} à la rescousse
]

.right-column[
`packrat.lock` généré dans le datalab

```r
# Générer uniquement le fichier packrat.lock
library(packrat)
.snapshotImpl(project = ".", 
*              snapshot.sources = FALSE)
```

* `packrat::restore()` dans l'environnement de déploiement le déploiement.

```r
library(packrat)
Sys.setenv(
  R_PACKRAT_CACHE_DIR = "<global-cache-dir>"
)
set_opts(use.cache = TRUE)
restore()
```
.color1[Astuce]: un cache packrat pour accélérer le déploiement.


] 

---

.left-column[
### Principalement des apps shiny
### {packrat} à la rescousse
### {config} pour adapter les configurations entre environnements
]

.right-column[
* Un seul fichier à adapter uniquement : `config.yml`:

```yaml
default:
  db-name: "db-test.acme.com"
  log-folder: "./local-log-folder"
  
*production:
  db-name: "db-prod.acme.com"
  log-folder: "/mnt/shared-log-folder"
```
* Le code R n'a pas à être changé:

```r
db_name <- config::get("db-name")
log-path <- config::get("log-folder")
```

* Dans l'environnement de déploiement

```r
Sys.setenv(R_CONFIG_ACTIVE = "production")
```


]

---
layout: false
# De l'appui dans la communauté
.subtitle[Où trouver de l'aide]

###  _R Admin_ sur community.rstudio.com

https://community.rstudio.com/c/r-admin

> This category is for discussions about R in production, at scale, and in complex environments.

### _R for Entreprise_ sur le blog RViews

https://rviews.rstudio.com/categories/r-for-the-enterprise/
+ [Some Ideas for your Internal R Package](https://rviews.rstudio.com/2017/07/19/supporting-corporate-r-user-groups/)
+ [Enterprise Dashboards with R Markdown](https://rviews.rstudio.com/2018/05/16/replacing-excel-reports-with-r-markdown-and-shiny/)

### S'entraider entre francophone

Une communauté slack francophone : https://frama.link/r-grrr


---
class: inverse, center, middle, title-slide
count: false
# MERCI
